<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="term.css">
  <script src="term.js"></script>
</head>
<body>
  <script>
    var app = Elm.Main.init();
    
    var socket = null;

    // Handlers for the four events
    function socketOpen(event) {
      console.debug(event);
      app.ports.openSocket.send(null);
    }
    function socketMsg(event) {
      console.debug(event);
      app.ports.msgSocket.send(event.data);
    }
    /*
    Websockets essentially have no data when an error occurs, just an error event...
    https://stackoverflow.com/questions/18803971/websocket-onerror-how-to-read-error-description
    For now, we just log the error in the console, but don't send anything to Elm.
    */
    function socketErr(event) {
      console.error(event);
    }
    // from link above, 1006 is basically the only result you will get
    function socketClose(event) {
      console.log(event);
      app.ports.closeSocket.send(event.code);
    }
 
    
    function disconnectSocket() {
      socket.close();
      socket = null;
    }

    // Create a new port, `connectSocket`, that connects a socket and sets it up appopriately
    app.ports.connectSocket.subscribe((address) => {
      // disconnect socket, if it is open
      if (socket != null) {
        disconnectSocket();
      }
      socket = new WebSocket(address);
      // add event handlers
      socket.addEventListener("open", socketOpen);
      socket.addEventListener("message", socketMsg);
      socket.addEventListener("error", socketErr);
      socket.addEventListener("close", socketClose);
    });

    // Create a new port, `writeSocket`, that writes a message to the socket
    app.ports.writeSocket.subscribe((data) => {
      if (socket != null) {
        socket.send(data);
      }
      // TODO: handle this specifically
      // maybe use the "error" port?
    });
  </script>
</body>
</html>